import re
import os
# import sys

MAIN_INIT_FILE_CONTENTS = '''from . import models
from . import wizards
'''

MANIFEST_FILE_CONTENTS = """{{
	'name': '{module_name}',
	'version': '{version}',
	'depends': {deps},
	'author': '{author}',
	'application': {is_application},
	'description': '{description}',
	'category': '{category}',
	'data': ['security/ir.model.access.csv'],
}}
"""

BASE_MODEL_FILE_CONTENTS = '''from odoo import api, fields, models

import logging
_logger = logging.getLogger(__name__)
'''

SECURITY_FILE_CONTENTS = 'id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink\n'

GENERATE_MODULE_PARAMETERS = [
    {
        'property_name': 'name',
        # 'property_label': 'Module Name',
        'property_type': str,
        'property_is_optional': False,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Please insert the module name'
    },
    {
        'property_name': 'is_application',
        # 'property_label': '',
        'property_type': bool,
        'property_is_optional': False,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Is the module an application?'
    },
    {
        'property_name': 'dependencies',
        'property_type': str,
        'property_is_optional': True,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Please specify any dependencies of the module'
    },
    {
        'property_name': 'author',
        'property_type': str,
        'property_is_optional': True,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Please specify the author of the module'
    },
    {
        'property_name': 'version',
        'property_type': str,
        'property_is_optional': True,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Please specify the starting version of the module'
    },
    {
        'property_name': 'description',
        'property_type': str,
        'property_is_optional': True,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Please insert a description for the module'
    },
    {
        'property_name': 'category',
        'property_type': str,
        'property_is_optional': True,
        'property_allowed_vals': None,
        'property_ask_for_val_msg': 'Please insert a category for the module'
    }
]

def handle_generate_module(
	name: str,
	is_application: bool,
	dependencies: str,
	author: str,
	version: str,
	description: str,
	category: str
) -> None:

	assert name, "Did not pass the module name!"
	
	module_name = re.sub(r'(?<!^)(?=[A-Z])', '_', name.replace(' ', '_')).lower()
	
	assert not os.path.isdir(module_name), "Module with same name already exists!"
	
	print(f"Generating new {'application' if is_application else 'module'}: {module_name}")

	module_path = os.path.join(os.getcwd(), module_name)
	print(f"[1] Creating {'Application' if is_application else 'Module'} directory")
	os.mkdir(module_path)

	print(f"[2] Creating {'Application' if is_application else 'Module'} internal directories")
	os.mkdir(os.path.join(module_path, 'models'))
	os.mkdir(os.path.join(module_path, 'views'))
	os.mkdir(os.path.join(module_path, 'security'))
	os.mkdir(os.path.join(module_path, 'wizards'))

	print("[3] Creating __init__.py, __manifest__.py and __init__.py in models/ and wizards/")
	
	with open(module_path + '/__init__.py', 'w') as init_file:
		init_file.write(MAIN_INIT_FILE_CONTENTS)

	with open(module_path + '/__manifest__.py', 'w') as manifest_file:
		manifest_file.write(MANIFEST_FILE_CONTENTS.format(
				module_name=module_name.replace('_', ' ').title(),
				version=version if version else '0.1',
				deps=dependencies.split(',') if dependencies else [],
				author=author if author else os.getlogin(), 
				is_application=is_application,
				description=description if description else '',
				category=category if category else ''
			)
		)

	with open(module_path + '/models/__init__.py', 'w') as models_init:
		models_init.write(f"from . import {module_name.replace(' ', '_')}\n")

	with open(module_path + f"/models/{module_name.replace(' ', '_')}.py", 'w') as models_base_file:
		models_base_file.write(BASE_MODEL_FILE_CONTENTS)

	print("[4] Creating ir.model.access.csv file in security/ folder")

	with open(module_path + f'/security/ir.model.access.csv', 'w') as security_file:
		security_file.write(SECURITY_FILE_CONTENTS)
